name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black
    
    - name: Run flake8
      run: |
        flake8 . --count --show-source --statistics
        echo "✓ Flake8 linting passed"
    
    - name: Check code formatting with black
      run: |
        black --check .
        echo "✓ Black formatting check passed"
    
    - name: Upload lint results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lint-results
        path: |
          .flake8
          pyproject.toml

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run preprocessing pipeline
      run: |
        python preprocessing_pipeline.py
    
    - name: Run unit tests with coverage
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          htmlcov/
          coverage.xml
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          .pytest_cache/
          test-results.xml
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MINIMUM_GREEN: 70
        MINIMUM_ORANGE: 50

  train:
    name: Model Training
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download and preprocess data
      run: |
        python 01_data_acquisition.py
        python 02_preprocessing.py
    
    - name: Feature engineering
      run: |
        python 04_feature_engineering.py
    
    - name: Train models with MLflow
      run: |
        python 07_mlflow_tracking.py
    
    - name: Evaluate models
      run: |
        python 06_model_evaluation.py
    
    - name: Package best model
      run: |
        python 09_model_packaging.py
    
    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-models
        path: |
          models/
          packaged_models/
          mlruns/
    
    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results
        path: |
          outputs/model_evaluation/
    
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-runs
        path: |
          mlruns/
          mlflow_artifacts/
    
    - name: Create training summary
      run: |
        echo "# Training Summary" > training_summary.md
        echo "## Training Date: $(date)" >> training_summary.md
        echo "## Models Trained: Logistic Regression, Random Forest, SVM, Gradient Boosting" >> training_summary.md
        echo "## Best Model: Random Forest" >> training_summary.md
        if [ -f "outputs/model_evaluation/evaluation_summary.csv" ]; then
          echo "## Evaluation Results:" >> training_summary.md
          cat outputs/model_evaluation/evaluation_summary.csv >> training_summary.md
        fi
    
    - name: Upload training summary
      uses: actions/upload-artifact@v4
      with:
        name: training-summary
        path: training_summary.md

  deploy:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Create deployment package
      run: |
        mkdir -p deployment-docs
        cp README.md deployment-docs/
        cp requirements.txt deployment-docs/
        cp environment.yml deployment-docs/
        if [ -f "packaged_models/README.md" ]; then
          cp packaged_models/README.md deployment-docs/MODEL_DEPLOYMENT.md
        fi
    
    - name: Upload deployment docs
      uses: actions/upload-artifact@v4
      with:
        name: deployment-docs
        path: deployment-docs/

  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [lint, test, train]
    if: always()
    
    steps:
    - name: Send notification
      run: |
        echo "Pipeline Status:"
        echo "- Linting: ${{ needs.lint.result }}"
        echo "- Testing: ${{ needs.test.result }}"
        echo "- Training: ${{ needs.train.result }}"
